<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- 核心：不发送 Referrer -->
    <meta name="referrer" content="no-referrer">
    <title>冬瓜TV</title>
    
    <!-- 360 CDN -->
    <link href="https://lib.baomitu.com/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://lib.baomitu.com/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://lib.baomitu.com/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://lib.baomitu.com/hls.js/1.1.5/hls.min.js"></script>
    <script src="https://lib.baomitu.com/dplayer/1.26.0/DPlayer.min.js"></script>
    <script src="https://lib.baomitu.com/vue/3.2.47/vue.global.prod.min.js"></script>
    <script src="https://lib.baomitu.com/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    
    <style>
        :root { 
            --bg-color: #141414; 
            --panel-bg: #1f1f1f;
            --accent: #e50914; 
            --text-main: #ffffff; 
            --text-sub: #b3b3b3; 
            --border: rgba(255,255,255,0.1);
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; min-height: 100vh; padding-bottom: 60px; overflow-x: hidden; }
        
        /* 屏蔽 DPlayer 提示 */
        .dplayer-notice, .dplayer-notice-list { display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; }

        /* 全局滚动条 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #141414; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* 导航 */
        .navbar-custom {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            padding: 15px 4%; display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%);
            transition: 0.3s;
        }
        .navbar-custom.scrolled { background: #141414; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
        .brand { font-size: 26px; font-weight: 800; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }

        /* Hero */
        .carousel-item { height: 70vh; background-color: #000; }
        .hero-bg {
            position: absolute; inset: 0; background-size: cover; background-position: center top;
            transition: transform 10s ease; mask-image: linear-gradient(to bottom, black 70%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
        }
        .carousel-item.active .hero-bg { transform: scale(1.05); }
        .hero-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(to top, #141414 0%, transparent 60%), linear-gradient(to right, rgba(0,0,0,0.8) 0%, transparent 50%);
            display: flex; align-items: center; padding-left: 5%;
        }
        .hero-content { max-width: 600px; margin-top: 60px; animation: fadeInUp 0.8s; }
        .hero-tag { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; display: inline-block; margin-bottom: 15px; backdrop-filter: blur(5px); }
        .hero-title { font-size: 3.5rem; font-weight: 900; line-height: 1.1; margin-bottom: 15px; text-shadow: 2px 2px 10px rgba(0,0,0,0.8); }
        .hero-desc { font-size: 1.1rem; color: #ddd; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); margin-bottom: 25px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .btn-play { background: #fff; color: #000; border: none; padding: 10px 30px; font-size: 1.2rem; font-weight: 700; border-radius: 4px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; }
        .btn-play:hover { transform: scale(1.05); }
        .btn-info { background: rgba(109, 109, 110, 0.7); color: #fff; border: none; padding: 10px 30px; font-size: 1.2rem; font-weight: 700; border-radius: 4px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; backdrop-filter: blur(5px); }
        .btn-info:hover { background: rgba(109, 109, 110, 0.5); }

        @media(max-width: 768px) {
            .carousel-item { height: 55vh; }
            .hero-title { font-size: 2.2rem; }
            .btn-play, .btn-info { padding: 8px 20px; font-size: 1rem; }
        }

        /* 搜索框 */
        .search-section { position: relative; margin-top: -35px; z-index: 20; padding: 0 5%; margin-bottom: 40px; }
        .search-box-wrapper { background: rgba(30, 30, 30, 0.9); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(20px); border-radius: 8px; display: flex; align-items: center; transition: 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .search-box-wrapper:focus-within { border-color: var(--accent); background: #000; }
        .search-icon { padding: 0 20px; color: #888; font-size: 18px; cursor: pointer;}
        .search-input { width: 100%; height: 60px; background: transparent; border: none; color: #fff; font-size: 18px; outline: none; }

        /* 列表通用 */
        .section-container { padding: 0 5%; margin-bottom: 40px; }
        .section-header { display: flex; align-items: center; margin-bottom: 15px; }
        .section-line { width: 4px; height: 22px; background: var(--accent); border-radius: 2px; margin-right: 12px; }
        .section-title { font-size: 1.4rem; font-weight: 700; color: #fff; margin: 0; line-height: 1; display: flex; align-items: center; gap: 10px; }
        .section-title i { font-size: 1.1rem; opacity: 0.7; }

        .hot-row { display: flex; gap: 14px; overflow-x: auto; padding-bottom: 20px; scroll-behavior: smooth; }
        .hot-row::-webkit-scrollbar { height: 0px; }
        
        .hot-card { min-width: 150px; width: 150px; cursor: pointer; transition: 0.3s; position: relative; }
        .hot-card:hover { transform: scale(1.08); z-index: 10; }
        
        .poster-wrap { width: 100%; aspect-ratio: 2/3; border-radius: 6px; overflow: hidden; background: #222; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.4); border: 1px solid var(--border); }
        .poster-wrap img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s; }
        
        .rank-badge { position: absolute; top: -12px; left: -8px; font-size: 64px; font-weight: 900; color: #141414; -webkit-text-stroke: 2px #666; font-family: impact, sans-serif; text-shadow: 2px 2px 0px #eee; z-index: 10; pointer-events: none; line-height: 1; }
        .rating-badge { position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); color: #46d369; font-weight: bold; font-size: 11px; padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(70, 211, 105, 0.3); }

        .poster-fallback { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(135deg, #333 0%, #111 100%); padding: 5px; text-align: center; }
        .fallback-text { font-size: 12px; color: #999; }

        .movie-name { margin-top: 10px; font-size: 14px; color: #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; font-weight: 500; }
        .movie-date { font-size: 12px; color: #666; text-align: center; margin-top: 2px; }

        .result-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; min-height: 300px; }
        .result-card { cursor: pointer; transition: 0.2s; }
        .result-card:hover { transform: translateY(-5px); }

        /* ★★★ 播放页重构：影院模式 ★★★ */
        .detail-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #141414; z-index: 9999; display: none; overflow-y: auto; }
        .detail-overlay.active { display: block; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .close-btn { 
            position: fixed; top: 25px; right: 30px; width: 44px; height: 44px; 
            background: rgba(255,255,255,0.1); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            color: #fff; cursor: pointer; z-index: 10005; backdrop-filter: blur(10px); 
            transition: 0.2s; border: 1px solid rgba(255,255,255,0.1);
        }
        .close-btn:hover { background: rgba(255,255,255,0.25); transform: rotate(90deg); }

        /* 布局容器 */
        .player-layout { max-width: 1200px; margin: 0 auto; padding: 90px 4% 50px; }

        /* 视频区域 */
        .player-box {
            width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5); margin-bottom: 30px; border: 1px solid #333;
        }

        /* 视频信息栏 */
        .video-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; flex-wrap: wrap; gap: 20px; }
        .video-title { font-size: 2.2rem; font-weight: 800; color: #fff; margin-bottom: 5px; line-height: 1.2; }
        .video-meta { color: #888; font-size: 14px; }
        
        /* 投屏按钮 */
        .btn-cast { 
            padding: 10px 20px; background: rgba(255,255,255,0.1); 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 30px; 
            color: #fff; font-weight: 600; display: flex; align-items: center; gap: 8px; 
            cursor: pointer; transition: 0.2s; font-size: 14px;
        }
        .btn-cast:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }

        /* 控制区域 (下半部分) */
        .controls-area {
            background: #1f1f1f; border-radius: 12px; padding: 30px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* 线路选择 (横向滚动) */
        .panel-title { font-size: 14px; color: #888; font-weight: 700; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; justify-content: space-between; }
        
        .source-list { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
        .source-pill { 
            padding: 8px 16px; border-radius: 6px; 
            background: #2a2a2a; border: 1px solid #333; 
            color: #ccc; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px;
            font-size: 13px; font-weight: 500;
        }
        .source-pill:hover { background: #333; border-color: #666; color: #fff; }
        .source-pill.active { background: var(--accent); border-color: var(--accent); color: #fff; box-shadow: 0 4px 15px rgba(229, 9, 20, 0.3); }
        
        /* 选集 (大网格) */
        .ep-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* 自适应宽度，最小100px */
            gap: 12px; 
        }
        .ep-btn { 
            background: #2a2a2a; border: 1px solid transparent; 
            color: #ddd; padding: 12px 5px; text-align: center; border-radius: 6px; 
            font-size: 14px; cursor: pointer; transition: 0.2s; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .ep-btn:hover { background: #333; color: #fff; border-color: #555; }
        .ep-btn.active { background: #fff; color: #000; font-weight: bold; border-color: #fff; }

        /* 状态灯 */
        .latency-dot { width: 6px; height: 6px; border-radius: 50%; }
        .dot-green { background: #46d369; box-shadow: 0 0 5px #46d369; } 
        .dot-yellow { background: #ffcc00; } 
        .dot-red { background: #ff453a; }

        .footer { text-align: center; font-size: 12px; color: #444; margin-top: 80px; padding-bottom: 20px; }
    </style>
</head>
<body>

<div id="app">
    
    <nav class="navbar-custom" :class="{ 'scrolled': scrollY > 50 }">
        <div class="brand">冬瓜TV <span style="font-size:12px; color:#666; font-weight:normal;">MAX</span></div>
        <a href="/admin.html" target="_blank" style="color:#888; text-decoration:none; font-size:12px;">Admin</a>
    </nav>

    <!-- 1. Hero Carousel -->
    <div id="heroCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="6000">
        <div class="carousel-inner" v-if="heroList.length > 0">
            <div class="carousel-item" v-for="(item, index) in heroList" :key="index" :class="{ active: index === 0 }">
                <div class="hero-bg" :style="{ backgroundImage: 'url(' + item.backdrop + ')' }"></div>
                <div class="hero-overlay">
                    <div class="hero-content">
                        <div class="hero-tag">本周 TOP {{ index + 1 }}</div>
                        <h1 class="hero-title">{{ item.title }}</h1>
                        <p class="hero-desc">{{ item.overview }}</p>
                        <div class="hero-btns">
                            <button class="btn-play" @click="autoSearch(item.title)"><i class="fas fa-play"></i> 播放</button>
                            <button class="btn-info" @click="autoSearch(item.title)"><i class="fas fa-info-circle"></i> 更多信息</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Search -->
    <div class="search-section">
        <div class="search-box-wrapper">
            <i class="fas fa-search search-icon" @click="doSearch"></i>
            <input type="text" v-model="keyword" @keyup.enter="doSearch" class="search-input" placeholder="输入片名、剧集、演员...">
        </div>
    </div>

    <div v-if="!searched">
        <!-- 3. TMDb Movies -->
        <div class="section-container animate__animated animate__fadeInUp" v-if="movieList.length > 0">
            <div class="section-header">
                <div class="section-line"></div>
                <div class="section-title"><i class="fas fa-film"></i> 全球震感·电影榜</div>
            </div>
            <div class="hot-row">
                <div class="hot-card" v-for="item in movieList" :key="item.id" @click="autoSearch(item.title)">
                    <div class="poster-wrap">
                        <img :src="'https://daili.smdhb.com/t/p/w300' + item.poster_path" loading="lazy">
                        <div class="rating-badge"><i class="fas fa-star text-warning"></i> {{ item.vote_average.toFixed(1) }}</div>
                    </div>
                    <div class="movie-name">{{ item.title }}</div>
                    <div class="movie-date">{{ item.release_date?.split('-')[0] }}</div>
                </div>
            </div>
        </div>

        <!-- 4. TMDb TV -->
        <div class="section-container animate__animated animate__fadeInUp" v-if="tvList.length > 0">
            <div class="section-header">
                <div class="section-line"></div>
                <div class="section-title"><i class="fas fa-tv"></i> 全球必追·剧集榜</div>
            </div>
            <div class="hot-row">
                <div class="hot-card" v-for="item in tvList" :key="item.id" @click="autoSearch(item.name)">
                    <div class="poster-wrap">
                        <img :src="'https://daili.smdhb.com/t/p/w300' + item.poster_path" loading="lazy">
                        <div class="rating-badge"><i class="fas fa-star text-warning"></i> {{ item.vote_average.toFixed(1) }}</div>
                    </div>
                    <div class="movie-name">{{ item.name }}</div>
                    <div class="movie-date">{{ item.first_air_date?.split('-')[0] }}</div>
                </div>
            </div>
        </div>

        <!-- 5. 华语强档 -->
        <div class="section-container animate__animated animate__fadeInUp" v-if="list_cn.length > 0">
            <div class="section-header">
                <div class="section-line"></div>
                <div class="section-title"><i class="fas fa-dragon"></i> 华语强档·国产剧</div>
            </div>
            <div class="hot-row">
                <div class="hot-card" v-for="item in list_cn" :key="item.id" @click="autoSearch(item.name)">
                    <div class="poster-wrap">
                        <img :src="'https://daili.smdhb.com/t/p/w300' + item.poster_path" loading="lazy">
                        <div class="rating-badge"><i class="fas fa-star text-warning"></i> {{ item.vote_average.toFixed(1) }}</div>
                    </div>
                    <div class="movie-name">{{ item.name }}</div>
                    <div class="movie-date">{{ item.first_air_date?.split('-')[0] }}</div>
                </div>
            </div>
        </div>

        <!-- 6. 日韩潮流 -->
        <div class="section-container animate__animated animate__fadeInUp" v-if="list_krjp.length > 0">
            <div class="section-header">
                <div class="section-line"></div>
                <div class="section-title"><i class="fas fa-mask"></i> 日韩潮流·剧集/动漫</div>
            </div>
            <div class="hot-row">
                <div class="hot-card" v-for="item in list_krjp" :key="item.id" @click="autoSearch(item.name)">
                    <div class="poster-wrap">
                        <img :src="'https://daili.smdhb.com/t/p/w300' + item.poster_path" loading="lazy">
                        <div class="rating-badge"><i class="fas fa-star text-warning"></i> {{ item.vote_average.toFixed(1) }}</div>
                    </div>
                    <div class="movie-name">{{ item.name }}</div>
                    <div class="movie-date">{{ item.first_air_date?.split('-')[0] }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Results -->
    <div id="search-result-anchor" class="section-container" v-if="searched">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="section-header mb-0">
                <div class="section-line"></div>
                <div class="section-title">搜索结果</div>
            </div>
            <button class="btn btn-sm btn-outline-secondary" @click="clearSearch">清除搜索 X</button>
        </div>

        <div v-if="loading" class="text-center py-5"><div class="spinner-border text-danger"></div></div>

        <div class="result-grid" v-if="!loading">
            <div class="result-card" v-for="group in groupedList" :key="group.name" @click="openDetail(group)">
                <div class="poster-wrap">
                    <img v-if="!isFallback(group.name)" :src="finalPoster(group)" :key="finalPoster(group)" referrerpolicy="no-referrer" @error="handleImgError(group.name)" loading="lazy">
                    <div v-else class="poster-fallback">
                        <i class="fas fa-film mb-2 opacity-50"></i>
                        <div style="font-size:12px; color:#999">{{ group.name }}</div>
                    </div>
                    <div class="rating-badge" style="background:var(--accent); color:#fff; border:none;">{{ group.sources.length }} 源</div>
                </div>
                <div class="movie-name">{{ group.name }}</div>
            </div>
        </div>
        
        <div v-if="!loading && groupedList.length === 0" class="text-center text-muted py-5">
            未找到相关内容，请尝试更换关键词
        </div>
    </div>

    <div class="footer">
        <div>kk爱吃王哥呆阿龟头 设计编写</div>
        <div style="font-size:10px; margin-top:5px; opacity:0.5;">Data provided by TMDb & Maccms APIs</div>
    </div>

    <!-- ★★★ 播放详情页 (影院布局) ★★★ -->
    <div class="detail-overlay" :class="{ active: showDetail }">
        <div class="close-btn" @click="closeDetail"><i class="fas fa-times"></i></div>
        
        <div class="player-layout" v-if="currentGroup">
            
            <!-- 1. 顶部：标题栏 + 投屏 -->
            <div class="video-header">
                <div>
                    <h1 class="video-title">{{ currentGroup.name }}</h1>
                    <div class="video-meta">
                        正在播放: <span class="text-white fw-bold">{{ currentSource?.site_name }}</span>
                    </div>
                </div>
                <button class="btn-cast" @click="castVideo">
                    <i class="fas fa-tv"></i> 一键投屏
                </button>
            </div>

            <!-- 2. 中部：超大播放器 -->
            <div class="player-box">
                <div id="dplayer" style="width: 100%; height: 100%;"></div>
            </div>

            <!-- 3. 底部：控制面板 -->
            <div class="controls-area">
                <!-- 线路选择 -->
                <div class="mb-4">
                    <div class="panel-title">切换线路 (真实测速)</div>
                    <div class="source-list">
                        <div v-for="source in currentGroup.sources" 
                             class="source-pill" 
                             :class="{ active: currentSource?.site_key === source.site_key }" 
                             @click="switchSource(source)">
                            <span>{{ source.site_name }}</span>
                            <span class="latency-dot" :class="getLatencyClass(source.latency)"></span>
                            <span style="font-size:10px; opacity:0.6;">{{source.latency}}ms</span>
                        </div>
                    </div>
                </div>

                <!-- 选集列表 (全宽网格) -->
                <div>
                    <div class="panel-title">选集播放</div>
                    <div v-if="loadingDetail" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>
                    <div v-else class="ep-grid">
                        <div v-for="ep in episodeList" 
                             class="ep-btn" 
                             :class="{ active: currentUrl === ep.url }" 
                             @click="play(ep.url)">
                            {{ ep.name }}
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

</div>

<script>
    const { createApp, reactive } = Vue;
    // 使用你的反代域名
    const MY_PROXY = "https://daili.smdhb.com";
    const TMDB_API_KEY = "替换成你自己的KEY"; 
    
    // API地址修改为你的反代
    const TMDB_BASE_URL = `${MY_PROXY}/3`;
    const TMDB_IMG_URL = `${MY_PROXY}/t/p/w500`;
    const TMDB_BACKDROP_URL = `${MY_PROXY}/t/p/original`;

    let dp = null;

    createApp({
        data() {
            return {
                keyword: '', loading: false, searched: false, rawList: [], 
                movieList: [], tvList: [], list_cn: [], list_krjp: [], list_hktw: [],
                showDetail: false, currentGroup: null, currentSource: null,
                episodeList: [], currentUrl: '', loadingDetail: false,
                imageMap: {}, fallbackMap: {}, heroList: [], scrollY: 0,
                hotList: [] 
            }
        },
        mounted() {
            window.addEventListener('scroll', () => { this.scrollY = window.scrollY; });
            this.fetchHero();
            this.fetchAllLists();
        },
        computed: {
            groupedList() {
                const groups = {};
                this.rawList.forEach(item => {
                    const name = item.vod_name;
                    if (!groups[name]) groups[name] = { name: name, pic: item.vod_pic, sources: [] };
                    const isDefault = (url) => !url || url.includes('mac_default') || url.includes('nopic');
                    if (isDefault(groups[name].pic) && !isDefault(item.vod_pic)) groups[name].pic = item.vod_pic;
                    if (isDefault(groups[name].pic)) this.handleImgError(name);
                    
                    groups[name].sources.push({
                        ...item,
                        latency: item.latency || 999 
                    });
                });
                return Object.values(groups).sort((a, b) => b.sources.length - a.sources.length);
            }
        },
        methods: {
            getLatencyClass(ms) { return ms < 500 ? 'dot-green' : (ms < 2000 ? 'dot-yellow' : 'dot-red'); },
            castVideo() {
                const videoEl = document.querySelector('.dplayer-video');
                if (!videoEl) return alert('请先播放视频');
                if (videoEl.remote && videoEl.remote.state !== 'disconnected') videoEl.remote.prompt().catch(() => {});
                else if (videoEl.webkitShowPlaybackTargetPicker) videoEl.webkitShowPlaybackTargetPicker();
                else alert('您的浏览器不支持网页直接投屏，请使用浏览器菜单中的投射功能。');
            },
            
            fetchAllLists() {
                fetch(`${TMDB_BASE_URL}/trending/movie/week?api_key=${TMDB_API_KEY}&language=zh-CN`)
                    .then(res => res.json()).then(data => { if(data.results) this.movieList = data.results; });
                fetch(`${TMDB_BASE_URL}/trending/tv/week?api_key=${TMDB_API_KEY}&language=zh-CN`)
                    .then(res => res.json()).then(data => { if(data.results) this.tvList = data.results; });
                fetch(`${TMDB_BASE_URL}/discover/tv?with_origin_country=CN&sort_by=popularity.desc&api_key=${TMDB_API_KEY}&language=zh-CN`)
                    .then(res => res.json()).then(data => { if(data.results) this.list_cn = data.results; });
                fetch(`${TMDB_BASE_URL}/discover/tv?with_origin_country=KR|JP&sort_by=popularity.desc&api_key=${TMDB_API_KEY}&language=zh-CN`)
                    .then(res => res.json()).then(data => { if(data.results) this.list_krjp = data.results; });
                fetch(`${TMDB_BASE_URL}/discover/movie?with_origin_country=HK|TW&sort_by=popularity.desc&api_key=${TMDB_API_KEY}&language=zh-CN`)
                    .then(res => res.json()).then(data => { if(data.results) this.list_hktw = data.results; });
            },

            fetchHero() {
                fetch(`${TMDB_BASE_URL}/trending/all/week?api_key=${TMDB_API_KEY}&language=zh-CN`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.results) {
                            this.heroList = data.results.filter(i => i.backdrop_path).slice(0, 5).map(item => ({
                                title: item.title || item.name,
                                overview: item.overview || '精彩内容不容错过',
                                backdrop: `${TMDB_BACKDROP_URL}${item.backdrop_path}`
                            }));
                        }
                    });
            },

            finalPoster(item, isHot = false) {
                const name = isHot ? item.vod_name : item.name;
                return this.imageMap[name] || (isHot ? item.vod_pic : item.pic);
            },
            isFallback(name) { return this.fallbackMap[name] === true; },
            
            handleImgError(name) {
                if (this.imageMap[name] || this.fallbackMap[name]) return;
                this.fallbackMap[name] = true; 
                let cleanName = name.replace(/第[0-9一二三四五六七八九十]+[季部]/g, '').replace(/Season\s*\d+/ig, '').replace(/S\d{1,2}/ig, '').replace(/(HD|BD|1080P|720P|4K|202\d|TC|TS).*/i, '').trim();
                fetch(`${TMDB_BASE_URL}/search/multi?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(cleanName)}&language=zh-CN`)
                    .then(res => res.json()).then(data => {
                        if (data.results && data.results.length > 0) {
                            const found = data.results.find(i => i.poster_path) || data.results[0];
                            if (found.poster_path) {
                                this.imageMap[name] = `${TMDB_IMG_URL}${found.poster_path}`;
                                this.fallbackMap[name] = false; 
                            }
                        }
                    }).catch(() => {});
            },

            autoSearch(name) { 
                this.keyword = name; 
                this.doSearch(); 
                setTimeout(() => {
                    document.getElementById('search-result-anchor').scrollIntoView({ behavior: 'smooth' });
                }, 100);
            },
            clearSearch() { this.searched = false; this.keyword = ''; this.rawList = []; },
            async doSearch() {
                if(!this.keyword) return;
                this.loading = true; 
                this.searched = true; 
                this.rawList = [];
                try {
                    const res = await fetch(`/api/search?wd=${encodeURIComponent(this.keyword)}`);
                    const data = await res.json();
                    this.rawList = data.list || [];
                    this.rawList.forEach(item => {
                         if(!item.vod_pic || item.vod_pic.includes('mac_default')) this.handleImgError(item.vod_name);
                    });
                } catch(e) {}
                this.loading = false;
            },
            openDetail(group) {
                this.currentGroup = group;
                this.showDetail = true;
                this.currentGroup.sources.forEach(source => {
                    source.latency = '...';
                    fetch(`/api/check?key=${source.site_key}`)
                        .then(res => res.json())
                        .then(data => { source.latency = data.latency; });
                });
                let best = group.sources[0];
                this.switchSource(best);
            },
            closeDetail() { this.showDetail = false; if(dp) dp.pause(); },
            async switchSource(source) {
                this.currentSource = source; this.loadingDetail = true; this.episodeList = [];
                try {
                    const res = await fetch(`/api/detail?site_key=${source.site_key}&id=${source.vod_id}`);
                    const data = await res.json();
                    if(data.list && data.list.length > 0) this.parseEpisodes(data.list[0].vod_play_url);
                } catch(e) {}
                this.loadingDetail = false;
            },
            parseEpisodes(urlStr) {
                let playSource = urlStr;
                if(urlStr.includes('$$$')) {
                    const sets = urlStr.split('$$$');
                    playSource = sets.find(s => s.toLowerCase().includes('m3u8')) || sets[0];
                }
                this.episodeList = playSource.split('#').map(ep => {
                    const p = ep.split('$');
                    return { name: p.length > 1 ? p[0] : '正片', url: p.length > 1 ? p[1] : p[0] };
                });
                if(this.episodeList.length > 0) this.play(this.episodeList[0].url);
            },
            play(url) {
                this.currentUrl = url;
                if(!dp) dp = new DPlayer({
                    container: document.getElementById('dplayer'),
                    theme: '#e50914', video: { url: url, type: 'hls' }
                });
                else dp.switchVideo({ url: url, type: 'hls' });
                dp.play();
            }
        }
    }).mount('#app');
</script>
</body>
</html>